<!doctype html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baza - ASMO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>
    <style>
      body {
        background-color: #f5f5f5;
        font-size: 14px;
      }
      .q-btn {
        font-size: 12px;
        padding: 6px;
        border-radius: 8px;
      }
      .active-q {
        background-color: #000 !important;
        color: #fff !important;
      }
      .summary-mini {
        background: #fff;
        border-radius: 10px;
        padding: 12px;
        border: 1px solid #ddd;
      }
      .table {
        font-size: 13px;
        background: #fff;
      }
      .sticky-top-custom {
        position: sticky;
        top: 0;
        background: #f5f5f5;
        z-index: 1000;
        padding-bottom: 10px;
      }
      .text-batch {
        color: #888;
        font-size: 11px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-2">
      <div class="sticky-top-custom">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="fw-bold m-0" id="baza-name">Baza</h6>
          <button class="btn btn-sm btn-outline-dark" onclick="history.back()">
            ‚Üê
          </button>
        </div>

        <div class="d-flex gap-1 mb-2">
          <button
            class="btn btn-light border q-btn flex-fill"
            id="q1"
            onclick="setQ(1)"
          >
            1-Ch
          </button>
          <button
            class="btn btn-light border q-btn flex-fill"
            id="q2"
            onclick="setQ(2)"
          >
            2-Ch
          </button>
          <button
            class="btn btn-light border q-btn flex-fill"
            id="q3"
            onclick="setQ(3)"
          >
            3-Ch
          </button>
          <button
            class="btn btn-light border q-btn flex-fill"
            id="q4"
            onclick="setQ(4)"
          >
            4-Ch
          </button>
        </div>

        <div class="summary-mini d-flex justify-content-around text-center">
          <div>
            <div class="text-muted small">MIQDOR</div>
            <b id="t-qty" class="text-dark">0</b>
          </div>
          <div style="width: 1px; background: #eee"></div>
          <div>
            <div class="text-muted small">JAMI SUMMA</div>
            <b id="t-sum" class="text-primary">0</b>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover border-top">
          <thead class="table-light">
            <tr>
              <th>Sana/Batch</th>
              <th class="text-center">Dona</th>
              <th class="text-end">Summa</th>
            </tr>
          </thead>
          <tbody id="b-data"></tbody>
        </table>
      </div>
    </div>

    <script>
      // Qaysi bo'limdan kelganini aniqlash
      const rawTitle = localStorage.getItem("activeSubTitle") || "";
      const filterKey = rawTitle.toUpperCase().includes("GORE")
        ? "GORE-TEX PATCH"
        : rawTitle.toUpperCase().includes("LED")
          ? "LED PCB"
          : "AVTO SWITCH";

      document.getElementById("baza-name").innerText = filterKey + " BAZA";

      let currentQ = Math.ceil((new Date().getMonth() + 1) / 3);

      function setQ(q) {
        currentQ = q;
        document
          .querySelectorAll(".q-btn")
          .forEach((b) => b.classList.remove("active-q"));
        document.getElementById("q" + q).classList.add("active-q");
        loadBaza();
      }

      function loadBaza() {
        db.ref("asmo_all_history").on("value", (snap) => {
          const list = document.getElementById("b-data");
          list.innerHTML = "";
          let totalQty = 0,
            totalSum = 0;

          if (snap.exists()) {
            const data = Object.values(snap.val()).reverse();

            data.forEach((item) => {
              // 1. Bo'lim bo'yicha filtr
              if (item.product === filterKey) {
                // 2. Chorak bo'yicha filtr
                const m = parseInt(item.time.split("/")[1]);
                const q = Math.ceil(m / 3);

                if (q === currentQ) {
                  const qy = parseFloat(item.qty) || 0;
                  const sm = parseFloat(item.jami_summa) || 0;
                  totalQty += qy;
                  totalSum += sm;

                  list.innerHTML += `
                                <tr>
                                    <td>
                                        <div class="fw-bold">${item.time.substring(0, 10)}</div>
                                        <div class="text-batch">${item.batch}</div>
                                    </td>
                                    <td class="text-center pt-2"><b>${qy.toLocaleString()}</b></td>
                                    <td class="text-end pt-2 text-primary"><b>${sm.toLocaleString()}</b></td>
                                </tr>
                            `;
                }
              }
            });
          }
          document.getElementById("t-qty").innerText =
            totalQty.toLocaleString();
          document.getElementById("t-sum").innerText =
            totalSum.toLocaleString() + " s.";

          if (!list.innerHTML)
            list.innerHTML =
              "<tr><td colspan='3' class='text-center p-4 text-muted'>Ma'lumot yo'q</td></tr>";
        });
      }

      setQ(currentQ);
    </script>
  </body>
</html>
