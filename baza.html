<!doctype html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baza - ASMO AVTO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>

    <style>
      :root {
        --primary-color: #2563eb;
        --bg-color: #f8fafc;
        --card-bg: #ffffff;
        --text-main: #1e293b;
        --text-muted: #64748b;
      }

      body {
        background-color: var(--bg-color);
        font-family:
          "Inter",
          -apple-system,
          sans-serif;
        color: var(--text-main);
      }

      /* Header qismi */
      .header-container {
        background: var(--card-bg);
        padding: 16px 0;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .back-arrow {
        text-decoration: none;
        color: var(--text-main);
        font-weight: bold;
        padding: 8px 0;
        display: inline-block;
      }

      .title-main {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .total-badge {
        background: #eff6ff;
        color: var(--primary-color);
        padding: 4px 12px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.9rem;
      }

      /* Qoldiq yorliqlari (Badges) */
      .stock-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
        padding: 12px 0;
      }

      .mini-card {
        background: var(--card-bg);
        border: 1px solid #e2e8f0;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 0.75rem;
      }

      .mini-card b {
        color: var(--text-muted);
        font-weight: 500;
      }
      .mini-card span {
        display: block;
        font-weight: 700;
        color: var(--text-main);
        margin-top: 2px;
      }

      /* Jadval uslubi */
      .main-table-card {
        background: var(--card-bg);
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
        margin-top: 10px;
      }

      .table thead {
        background: #f1f5f9;
      }

      .table thead th {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        border: none;
        padding: 12px 8px;
      }

      .table tbody td {
        padding: 14px 8px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.85rem;
      }

      .time-text {
        font-size: 0.7rem;
        color: var(--text-muted);
        display: block;
      }
      .qty-text {
        font-weight: 700;
        color: var(--primary-color);
      }
      .sum-text {
        font-weight: 600;
        color: #059669;
      }

      /* Tahrirlash tugmasi */
      .edit-link {
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 8px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
      }

      /* Uzun matnlar uchun */
      .text-truncate-custom {
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
      }

      /* Modal */
      .modal-content {
        border-radius: 20px;
        border: none;
      }
      .form-control {
        border-radius: 10px;
        padding: 10px;
        border: 1px solid #e2e8f0;
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <a href="index.html" class="back-arrow">←</a>
          <h1 class="title-main" id="baza-title">Baza</h1>
          <div class="total-badge">
            <span id="total-stock-display">0</span> dona
          </div>
        </div>
        <div id="size-stocks" class="stock-grid"></div>
      </div>
    </div>

    <div class="container pb-5">
      <div class="main-table-card">
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead>
              <tr>
                <th>Vaqt</th>
                <th>Mahsulot</th>
                <th class="text-center">Kirim</th>
                <th class="text-end">Amal</th>
              </tr>
            </thead>
            <tbody id="baza-table">
              <tr>
                <td colspan="4" class="text-center py-5 text-muted">
                  Yuklanmoqda...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content shadow-lg">
          <div class="modal-body p-4">
            <h6 class="fw-bold mb-3">Tahrirlash</h6>
            <input type="hidden" id="edit-id" />
            <div class="mb-3">
              <label class="small text-muted mb-1">Sana va vaqt</label>
              <input
                type="datetime-local"
                id="edit-time"
                class="form-control"
              />
            </div>
            <div class="mb-3">
              <label class="small text-muted mb-1">Miqdor</label>
              <input type="number" id="edit-qty" class="form-control" />
            </div>
            <div class="d-grid gap-2">
              <button
                onclick="saveEdit()"
                class="btn btn-primary fw-bold"
                style="border-radius: 10px"
              >
                Saqlash
              </button>
              <button
                class="btn btn-light text-muted fw-bold"
                data-bs-dismiss="modal"
                style="border-radius: 10px"
              >
                Bekor qilish
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const savedTitle = (
        localStorage.getItem("activeSubTitle") || ""
      ).toUpperCase();
      const savedType = localStorage.getItem("selectedProduct") || "";

      let filterName = "LED PCB";
      if (savedTitle.includes("GORE") || savedType === "Gore")
        filterName = "GORE-TEX PATCH";
      if (savedTitle.includes("SWITCH") || savedType === "Switch")
        filterName = "AVTO SWITCH";

      document.getElementById("baza-title").innerText = filterName;

      function updateUI() {
        db.ref("asmo_all_history").once("value", (hSnap) => {
          let sizeStats = {};
          let totalQty = 0;
          let records = [];
          const isGore = filterName.includes("GORE");

          if (hSnap.exists()) {
            hSnap.forEach((child) => {
              const item = child.val();
              if (item.product === filterName) {
                const sKey = isGore
                  ? `${item.size || ""} ${item.code || ""}`
                  : filterName;
                if (!sizeStats[sKey]) sizeStats[sKey] = 0;
                sizeStats[sKey] += parseFloat(item.qty || 0);
                totalQty += parseFloat(item.qty || 0);
                records.push({ ...item, id: child.key });
              }
            });
          }

          db.ref("asmo_logistika_history").once("value", (lSnap) => {
            if (lSnap.exists()) {
              lSnap.forEach((child) => {
                const s = child.val();
                if (s.product === filterName) {
                  const sKey =
                    isGore && s.item ? s.item.replace("|", " ") : filterName;
                  if (sizeStats[sKey] !== undefined) {
                    sizeStats[sKey] -= parseFloat(s.qty || 0);
                    totalQty -= parseFloat(s.qty || 0);
                  }
                }
              });
            }

            // Yuqoridagi kichik kartalar
            const sizeContainer = document.getElementById("size-stocks");
            sizeContainer.innerHTML = "";
            for (const [key, val] of Object.entries(sizeStats)) {
              sizeContainer.innerHTML += `
                <div class="mini-card">
                  <b>${key}</b>
                  <span>${val.toLocaleString()}</span>
                </div>`;
            }
            document.getElementById("total-stock-display").innerText =
              totalQty.toLocaleString();

            // Jadval
            const table = document.getElementById("baza-table");
            if (records.length > 0) {
              table.innerHTML = records
                .reverse()
                .map(
                  (item) => `
                <tr>
                  <td>
                    <span class="time-text">${item.time ? item.time.split(",")[0] : "-"}</span>
                    <span class="time-text" style="font-weight:600">${item.time ? item.time.split(",")[1] : ""}</span>
                  </td>
                  <td>
                    <div style="font-weight:600; font-size: 0.8rem;">${item.batch || "No Batch"}</div>
                    <div class="text-muted" style="font-size: 0.7rem;">${item.size || ""}</div>
                  </td>
                  <td class="text-center">
                    <span class="qty-text">+${parseFloat(item.qty).toLocaleString()}</span>
                  </td>
                  <td class="text-end">
                    <a href="#" class="edit-link" onclick="openEditModal('${item.id}', '${item.time}', '${item.qty}')">✏️</a>
                  </td>
                </tr>`,
                )
                .join("");
            } else {
              table.innerHTML =
                "<tr><td colspan='4' class='text-center py-5'>Ma'lumot yo'q</td></tr>";
            }
          });
        });
      }

      function openEditModal(id, time, qty) {
        document.getElementById("edit-id").value = id;
        document.getElementById("edit-qty").value = qty;
        try {
          const p = time.split(", ");
          const d = p[0].split("/");
          const formatted = `${d[2]}-${d[1]}-${d[0]}T${p[1].substring(0, 5)}`;
          document.getElementById("edit-time").value = formatted;
        } catch (e) {
          document.getElementById("edit-time").value = "";
        }
        new bootstrap.Modal(document.getElementById("editModal")).show();
      }

      function saveEdit() {
        const id = document.getElementById("edit-id").value;
        const newTimeRaw = document.getElementById("edit-time").value;
        const newQty = document.getElementById("edit-qty").value;
        if (!newTimeRaw || !newQty) return alert("To'ldiring!");
        const d = new Date(newTimeRaw);
        const newTimeStr = d.toLocaleString("uz-UZ").replace(/\./g, "/");

        db.ref("asmo_all_history/" + id)
          .update({
            time: newTimeStr,
            qty: parseFloat(newQty),
            timestamp: d.getTime(),
          })
          .then(() => {
            bootstrap.Modal.getInstance(
              document.getElementById("editModal"),
            ).hide();
            updateUI();
          });
      }

      db.ref("asmo_all_history").on("value", updateUI);
    </script>
  </body>
</html>
