<!doctype html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baza - ASMO AVTO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>

    <style>
      body {
        background-color: #f4f7f6;
        font-family: "Segoe UI", sans-serif;
      }
      .main-card {
        border-radius: 20px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      }
      .sticky-header {
        position: sticky;
        top: 0;
        background: #f4f7f6;
        z-index: 100;
        padding: 15px 0;
        border-bottom: 1px solid #e0e0e0;
      }
      .stock-badge-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .stock-mini-badge {
        background: #fff;
        padding: 5px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .text-summa {
        color: #198754;
        font-weight: bold;
      }
      .back-btn {
        text-decoration: none;
        color: #333;
        margin-right: 15px;
        font-size: 1.2rem;
      }
      .btn-edit {
        padding: 4px 10px;
        font-size: 0.9rem;
        border-radius: 8px;
        transition: 0.3s;
      }
      .btn-edit:hover {
        background-color: #0d6efd;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="sticky-header mb-3">
      <div class="container">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <a href="index.html" class="back-btn">‚¨ÖÔ∏è</a>
            <h2 class="fw-bold mb-0">üìä <span id="baza-title">Baza</span></h2>
          </div>
          <div class="fw-bold text-end">
            <small class="text-muted d-block" style="font-size: 0.7rem"
              >UMUMIY QOLDIQ</small
            >
            <span id="total-stock-display" class="badge bg-primary fs-6"
              >0</span
            >
            <small>dona</small>
          </div>
        </div>
        <div id="size-stocks" class="stock-badge-container"></div>
      </div>
    </div>

    <div class="container pb-5">
      <div class="card main-card shadow-sm">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 text-center">
            <thead class="table-light">
              <tr>
                <th class="py-3">Sana</th>
                <th class="py-3">Mahsulot / Ma'lumot</th>
                <th class="py-3">Partiya</th>
                <th class="py-3">Kirim</th>
                <th class="py-3">Summa</th>
                <th class="py-3">Amal</th>
              </tr>
            </thead>
            <tbody id="baza-table">
              <tr>
                <td colspan="6" class="py-5 text-center">
                  Ma'lumotlar yuklanmoqda...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div
          class="modal-content"
          style="
            border-radius: 20px;
            border: none;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
          "
        >
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">Tahrirlash</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edit-id" />
            <div class="mb-3">
              <label class="form-label small fw-bold text-muted"
                >SANA VA VAQT</label
              >
              <input
                type="datetime-local"
                id="edit-time"
                class="form-control"
                style="border-radius: 10px"
              />
            </div>
            <div class="mb-3">
              <label class="form-label small fw-bold text-muted"
                >MIQDOR (DONA)</label
              >
              <input
                type="number"
                id="edit-qty"
                class="form-control"
                style="border-radius: 10px"
              />
            </div>
            <button
              onclick="saveEdit()"
              class="btn btn-primary w-100 py-2 fw-bold"
              style="border-radius: 12px"
            >
              SAQLASH
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 1. FILTR VA NOMNI ANIQLASH
      const savedTitle = (
        localStorage.getItem("activeSubTitle") || ""
      ).toUpperCase();
      const savedType = localStorage.getItem("selectedProduct") || "";

      let filterName = "LED PCB";
      if (savedTitle.includes("GORE") || savedType === "Gore")
        filterName = "GORE-TEX PATCH";
      if (savedTitle.includes("SWITCH") || savedType === "Switch")
        filterName = "AVTO SWITCH";

      document.getElementById("baza-title").innerText = filterName;

      // 2. MA'LUMOTLARNI CHIQARISH
      function updateUI() {
        db.ref("asmo_all_history").once("value", (hSnap) => {
          let sizeStats = {};
          let totalQty = 0;
          let records = [];
          const isGore = filterName.includes("GORE");

          if (hSnap.exists()) {
            hSnap.forEach((child) => {
              const item = child.val();
              // Faqat tanlangan mahsulotni ko'rsatish
              if (item.product === filterName) {
                const sKey = isGore
                  ? `${item.size || ""} (${item.code || ""})`
                  : filterName;
                if (!sizeStats[sKey]) sizeStats[sKey] = 0;
                sizeStats[sKey] += parseFloat(item.qty || 0);
                totalQty += parseFloat(item.qty || 0);

                records.push({ ...item, id: child.key });
              }
            });
          }

          // Logistikani ayirish (qoldiqni to'g'ri ko'rsatish uchun)
          db.ref("asmo_logistika_history").once("value", (lSnap) => {
            if (lSnap.exists()) {
              lSnap.forEach((child) => {
                const s = child.val();
                if (s.product === filterName) {
                  const sKey =
                    isGore && s.item
                      ? s.item.replace("|", " (") + ")"
                      : filterName;
                  if (sizeStats[sKey] !== undefined) {
                    sizeStats[sKey] -= parseFloat(s.qty || 0);
                    totalQty -= parseFloat(s.qty || 0);
                  }
                }
              });
            }

            // Qoldiq badgelari
            const sizeContainer = document.getElementById("size-stocks");
            sizeContainer.innerHTML = "";
            if (isGore) {
              for (const [key, val] of Object.entries(sizeStats)) {
                sizeContainer.innerHTML += `<div class="stock-mini-badge"><b>${key}:</b> ${val}</div>`;
              }
            }
            document.getElementById("total-stock-display").innerText =
              totalQty.toLocaleString();

            // Jadvalni to'ldirish
            const table = document.getElementById("baza-table");
            if (records.length > 0) {
              table.innerHTML = records
                .reverse()
                .map(
                  (item) => `
                <tr>
                  <td><small class="text-muted">${item.time || item.date || "-"}</small></td>
                  <td>
                    <strong>${item.product}</strong>
                    ${isGore && item.size ? `<br><small class="text-secondary">${item.size} / ${item.code}</small>` : ""}
                  </td>
                  <td><span class="badge bg-light text-dark border">${item.batch || "-"}</span></td>
                  <td class="fw-bold text-primary">+${parseFloat(item.qty || 0).toLocaleString()}</td>
                  <td class="text-summa">${parseFloat(item.jami_summa || item.qty * (item.price || 0)).toLocaleString()}</td>
                  <td>
                    <button class="btn btn-outline-primary btn-edit" onclick="openEditModal('${item.id}', '${item.time || item.date}', '${item.qty}')">‚úèÔ∏è</button>
                  </td>
                </tr>`,
                )
                .join("");
            } else {
              table.innerHTML = `<tr><td colspan="6" class="py-5 text-muted">Hozircha ma'lumot yo'q.<br><small>Kategoriya: ${filterName}</small></td></tr>`;
            }
          });
        });
      }

      // 3. TAHRIRLASH FUNKSIYALARI
      function openEditModal(id, time, qty) {
        document.getElementById("edit-id").value = id;
        document.getElementById("edit-qty").value = qty;

        // Sanani modalga moslash
        try {
          // "12/02/2026, 22:30" -> "2026-02-12T22:30"
          const p = time.split(", ");
          const d = p[0].split("/");
          const formatted = `${d[2]}-${d[1]}-${d[0]}T${p[1].substring(0, 5)}`;
          document.getElementById("edit-time").value = formatted;
        } catch (e) {
          // Agar sana formati boshqacha bo'lsa hozirgi vaqtni qo'yadi
          document.getElementById("edit-time").value = new Date()
            .toISOString()
            .slice(0, 16);
        }

        new bootstrap.Modal(document.getElementById("editModal")).show();
      }

      function saveEdit() {
        const id = document.getElementById("edit-id").value;
        const newTimeRaw = document.getElementById("edit-time").value;
        const newQty = document.getElementById("edit-qty").value;

        if (!newTimeRaw || !newQty) return alert("Ma'lumotni to'liq kiriting!");

        const d = new Date(newTimeRaw);
        const newTimeStr = d.toLocaleString("uz-UZ").replace(/\./g, "/");

        if (confirm("Ma'lumotni o'zgartirishni tasdiqlaysizmi?")) {
          db.ref("asmo_all_history/" + id)
            .update({
              time: newTimeStr,
              qty: parseFloat(newQty),
              timestamp: d.getTime(),
            })
            .then(() => {
              bootstrap.Modal.getInstance(
                document.getElementById("editModal"),
              ).hide();
              // Real vaqtda yangilash uI chaqiriladi
            })
            .catch((err) => alert("Xato: " + err.message));
        }
      }

      // Real-time listen
      db.ref("asmo_all_history").on("value", updateUI);
    </script>
  </body>
</html>
