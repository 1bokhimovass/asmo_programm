<!doctype html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baza - ASMO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>
    <style>
      body {
        background-color: #f5f5f5;
        font-size: 14px;
      }
      .q-btn {
        font-size: 12px;
        padding: 6px;
        border-radius: 8px;
        flex: 1;
      }
      .active-q {
        background-color: #000 !important;
        color: #fff !important;
      }
      .summary-mini {
        background: #fff;
        border-radius: 10px;
        padding: 12px;
        border: 1px solid #ddd;
      }
      .table {
        font-size: 13px;
        background: #fff;
      }
      .sticky-top-custom {
        position: sticky;
        top: 0;
        background: #f5f5f5;
        z-index: 1000;
        padding: 10px 0;
      }
      .btn-edit {
        padding: 2px 8px;
        font-size: 11px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-2">
      <div class="sticky-top-custom">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="fw-bold m-0" id="baza-name">Baza</h6>
          <button class="btn btn-sm btn-outline-dark" onclick="history.back()">
            ←
          </button>
        </div>

        <div class="d-flex gap-1 mb-2">
          <button class="btn btn-light border q-btn" id="q1" onclick="setQ(1)">
            1-Ch
          </button>
          <button class="btn btn-light border q-btn" id="q2" onclick="setQ(2)">
            2-Ch
          </button>
          <button class="btn btn-light border q-btn" id="q3" onclick="setQ(3)">
            3-Ch
          </button>
          <button class="btn btn-light border q-btn" id="q4" onclick="setQ(4)">
            4-Ch
          </button>
        </div>

        <div
          class="summary-mini d-flex justify-content-around text-center shadow-sm"
        >
          <div>
            <div class="text-muted small">MIQDOR</div>
            <b id="t-qty">0</b>
          </div>
          <div style="width: 1px; background: #eee"></div>
          <div>
            <div class="text-muted small">JAMI SUMMA</div>
            <b id="t-sum" class="text-primary">0</b>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Sana/Batch</th>
              <th class="text-center">Dona</th>
              <th class="text-end">Amal</th>
            </tr>
          </thead>
          <tbody id="b-data"></tbody>
        </table>
      </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-body">
            <h6 class="fw-bold mb-3">Tahrirlash</h6>
            <input type="hidden" id="edit-id" />
            <div class="mb-2">
              <label class="small text-muted">Sana va vaqt</label>
              <input
                type="datetime-local"
                id="edit-time"
                class="form-control form-control-sm"
              />
            </div>
            <div class="mb-3">
              <label class="small text-muted">Miqdor (dona)</label>
              <input
                type="number"
                id="edit-qty"
                class="form-control form-control-sm"
              />
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-primary btn-sm" onclick="saveEdit()">
                SAQLASH
              </button>
              <button class="btn btn-light btn-sm" data-bs-dismiss="modal">
                Yopish
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const rawTitle = localStorage.getItem("activeSubTitle") || "";
      const filterKey = rawTitle.toUpperCase().includes("GORE")
        ? "GORE-TEX PATCH"
        : rawTitle.toUpperCase().includes("LED")
          ? "LED PCB"
          : "AVTO SWITCH";
      document.getElementById("baza-name").innerText = filterKey;

      let currentQ = Math.ceil((new Date().getMonth() + 1) / 3);
      const modal = new bootstrap.Modal(document.getElementById("editModal"));

      function setQ(q) {
        currentQ = q;
        document
          .querySelectorAll(".q-btn")
          .forEach((b) => b.classList.remove("active-q"));
        document.getElementById("q" + q).classList.add("active-q");
        loadBaza();
      }

      function loadBaza() {
        db.ref("asmo_all_history").on("value", (snap) => {
          const list = document.getElementById("b-data");
          list.innerHTML = "";
          let tQ = 0,
            tS = 0;

          if (snap.exists()) {
            const data = snap.val();
            Object.keys(data)
              .reverse()
              .forEach((key) => {
                const item = data[key];
                if (item.product === filterKey) {
                  const m = parseInt(item.time.split("/")[1]);
                  if (Math.ceil(m / 3) === currentQ) {
                    tQ += parseFloat(item.qty) || 0;
                    tS += parseFloat(item.jami_summa) || 0;

                    list.innerHTML += `
                                <tr>
                                    <td>
                                        <div class="fw-bold">${item.time.split(",")[0]}</div>
                                        <div class="text-muted small">${item.batch}</div>
                                    </td>
                                    <td class="text-center"><b>${item.qty}</b></td>
                                    <td class="text-end">
                                        <button class="btn btn-outline-primary btn-edit" 
                                            onclick="openEdit('${key}', '${item.qty}', '${item.time}')">✎</button>
                                    </td>
                                </tr>`;
                  }
                }
              });
          }
          document.getElementById("t-qty").innerText = tQ.toLocaleString();
          document.getElementById("t-sum").innerText = tS.toLocaleString();
        });
      }

      function openEdit(id, qty, time) {
        document.getElementById("edit-id").value = id;
        document.getElementById("edit-qty").value = qty;

        // Sanani inputga moslash (13/02/2026 -> 2026-02-13T10:00)
        try {
          const p = time.split(", ");
          const d = p[0].split("/");
          const formatted = `${d[2]}-${d[1]}-${d[0]}T${p[1].substring(0, 5)}`;
          document.getElementById("edit-time").value = formatted;
        } catch (e) {
          console.log("Sana formatida xato");
        }

        modal.show();
      }

      function saveEdit() {
        const id = document.getElementById("edit-id").value;
        const newQty = document.getElementById("edit-qty").value;
        const newTimeRaw = document.getElementById("edit-time").value;

        if (!newTimeRaw || !newQty) return alert("Ma'lumotni to'liq kiriting!");

        const d = new Date(newTimeRaw);
        const newTimeStr = d.toLocaleString("uz-UZ").replace(/\./g, "/");

        // Bazani yangilash
        db.ref("asmo_all_history/" + id)
          .update({
            qty: parseFloat(newQty),
            time: newTimeStr,
            // Jami summani ham qayta hisoblab qo'yamiz (agar narx mavjud bo'lsa)
            // Bu yerda eski narxni saqlab qolish uchun avval ma'lumotni olish kerak bo'ladi,
            // lekin ko'p hollarda jami_summa qty*price bo'ladi.
          })
          .then(() => {
            modal.hide();
          });
      }

      setQ(currentQ);
    </script>
  </body>
</html>
