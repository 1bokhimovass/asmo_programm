<!doctype html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xarajatlar Paneli - ASMO AVTO</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="config.js"></script>

    <style>
      :root {
        --primary-dark: #1e293b;
        --accent-blue: #3b82f6;
        --card-bg: #ffffff;
      }

      body {
        background-color: #f8fafc;
        font-family: "Plus Jakarta Sans", sans-serif;
        color: var(--primary-dark);
      }

      .dept-header {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: white;
        padding: 30px;
        border-radius: 24px;
        margin-bottom: 30px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      }

      .input-card {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid #e2e8f0;
        padding: 25px;
        margin-bottom: 40px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }

      /* Chorak Knopkalari */
      .chorak-btn {
        width: 100%;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 18px;
        padding: 22px 28px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
        cursor: pointer;
        text-align: left;
      }

      .chorak-btn:hover {
        transform: translateY(-4px);
        border-color: var(--accent-blue);
        box-shadow: 0 15px 30px -5px rgba(59, 130, 246, 0.15);
      }

      .chorak-btn:not(.collapsed) {
        background: #f0f7ff;
        border-color: var(--accent-blue);
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        margin-bottom: 0;
      }

      .chorak-title {
        font-weight: 700;
        font-size: 1.15rem;
      }

      .q-sum-box {
        background: #fee2e2;
        color: #ef4444;
        padding: 10px 20px;
        border-radius: 14px;
        font-weight: 800;
        font-size: 1.05rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .q-content {
        background: white;
        border: 2px solid var(--accent-blue);
        border-top: none;
        border-bottom-left-radius: 18px;
        border-bottom-right-radius: 18px;
        margin-bottom: 20px;
      }

      .table th {
        background: #f8fafc;
        font-size: 0.85rem;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.5px;
      }
      .table td {
        padding: 16px;
        vertical-align: middle;
      }

      .elektrod-active {
        background-color: #fffbeb !important;
        border-left: 4px solid #f59e0b;
      }
      .btn-save {
        background: var(--accent-blue);
        border: none;
        padding: 12px;
        border-radius: 12px;
        font-weight: 700;
        transition: 0.3s;
      }
      .btn-save:hover {
        background: #2563eb;
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div
        class="dept-header d-flex justify-content-between align-items-center"
      >
        <div>
          <h2 id="display-dept-name" class="fw-bold mb-1 text-uppercase">
            YUKLANMOQDA...
          </h2>
          <p class="text-white-50 m-0">
            Moliyaviy xarajatlar va hisobotlar jurnali
          </p>
        </div>
        <a
          href="index.html"
          class="btn btn-light rounded-pill px-4 fw-bold shadow-sm"
          >Orqaga</a
        >
      </div>

      <div class="input-card">
        <h5 class="fw-bold mb-4">Ma'lumotlarni kiriting</h5>
        <div class="row g-3">
          <div class="col-md-2">
            <label class="small fw-bold text-muted mb-2">Sana</label>
            <input
              type="date"
              id="x_date"
              class="form-control form-control-lg border-0 bg-light rounded-3"
            />
          </div>
          <div class="col-md-3">
            <label class="small fw-bold text-muted mb-2">Xarajat Turi</label>
            <input
              list="x_list"
              id="x_type"
              class="form-control form-control-lg border-0 bg-light rounded-3"
              placeholder="Tanlang yoki yozing..."
            />
            <datalist id="x_list">
              <option value="taksi yo'l kro lar"></option>
              <option value="maxsus ishi oyligi"></option>
              <option value="qo'shimcha xarajat"></option>
              <option value="skoch"></option>
              <option value="upakovka kilyonka"></option>
              <option value="oziq ovqat u,n"></option>
              <option value="mexmon u,n xarajat"></option>
              <option value="elektr"></option>
              <option value="payka qalay"></option>
              <option value="payatnik"></option>
              <option value="razbavitel 646"></option>
            </datalist>
          </div>
          <div class="col-md-2">
            <label class="small fw-bold text-muted mb-2">Summa (so'm)</label>
            <input
              type="number"
              id="x_summa"
              class="form-control form-control-lg border-0 bg-light rounded-3"
              placeholder="0"
            />
          </div>
          <div class="col-md-3">
            <label class="small fw-bold text-muted mb-2">Izoh</label>
            <input
              type="text"
              id="x_info"
              class="form-control form-control-lg border-0 bg-light rounded-3"
              placeholder="Batafsil..."
            />
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button id="saveBtn" class="btn btn-primary btn-save w-100 shadow">
              SAQLASH
            </button>
          </div>
        </div>
      </div>

      <div id="chorakAccordion">
        <div class="chorak-wrapper">
          <div
            class="chorak-btn collapsed"
            data-bs-toggle="collapse"
            data-bs-target="#body-q1"
          >
            <div class="chorak-title">
              1-CHORAK
              <small class="text-muted ms-2 fw-normal">(Yan-Mar)</small>
            </div>
            <div class="q-sum-box" id="total-q1">0 so'm</div>
          </div>
          <div
            id="body-q1"
            class="collapse q-content"
            data-bs-parent="#chorakAccordion"
          >
            <div class="table-responsive">
              <table class="table">
                <thead class="text-center">
                  <tr>
                    <th>Sana</th>
                    <th>Tur</th>
                    <th>Izoh</th>
                    <th>Summa</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="list-q1" class="text-center"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="chorak-wrapper">
          <div
            class="chorak-btn collapsed"
            data-bs-toggle="collapse"
            data-bs-target="#body-q2"
          >
            <div class="chorak-title">
              2-CHORAK
              <small class="text-muted ms-2 fw-normal">(Apr-Iyun)</small>
            </div>
            <div
              class="q-sum-box"
              id="total-q2"
              style="background: #dcfce7; color: #16a34a"
            >
              0 so'm
            </div>
          </div>
          <div
            id="body-q2"
            class="collapse q-content"
            data-bs-parent="#chorakAccordion"
          >
            <div class="table-responsive">
              <table class="table">
                <thead class="text-center">
                  <tr>
                    <th>Sana</th>
                    <th>Tur</th>
                    <th>Izoh</th>
                    <th>Summa</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="list-q2" class="text-center"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="chorak-wrapper">
          <div
            class="chorak-btn collapsed"
            data-bs-toggle="collapse"
            data-bs-target="#body-q3"
          >
            <div class="chorak-title">
              3-CHORAK
              <small class="text-muted ms-2 fw-normal">(Iyul-Sen)</small>
            </div>
            <div
              class="q-sum-box"
              id="total-q3"
              style="background: #fef9c3; color: #a16207"
            >
              0 so'm
            </div>
          </div>
          <div
            id="body-q3"
            class="collapse q-content"
            data-bs-parent="#chorakAccordion"
          >
            <div class="table-responsive">
              <table class="table">
                <thead class="text-center">
                  <tr>
                    <th>Sana</th>
                    <th>Tur</th>
                    <th>Izoh</th>
                    <th>Summa</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="list-q3" class="text-center"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="chorak-wrapper">
          <div
            class="chorak-btn collapsed"
            data-bs-toggle="collapse"
            data-bs-target="#body-q4"
          >
            <div class="chorak-title">
              4-CHORAK
              <small class="text-muted ms-2 fw-normal">(Okt-Dek)</small>
            </div>
            <div
              class="q-sum-box"
              id="total-q4"
              style="background: #f1f5f9; color: #475569"
            >
              0 so'm
            </div>
          </div>
          <div
            id="body-q4"
            class="collapse q-content"
            data-bs-parent="#chorakAccordion"
          >
            <div class="table-responsive">
              <table class="table">
                <thead class="text-center">
                  <tr>
                    <th>Sana</th>
                    <th>Tur</th>
                    <th>Izoh</th>
                    <th>Summa</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="list-q4" class="text-center"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const activeDept = urlParams.get("dept") || "LED_PCB";
      document.getElementById("display-dept-name").innerText =
        activeDept.replace("_", " ") + " XARAJATLARI";
      document.getElementById("x_date").valueAsDate = new Date();

      document.getElementById("saveBtn").onclick = function () {
        const date = document.getElementById("x_date").value;
        const type = document.getElementById("x_type").value.trim();
        const sum = document.getElementById("x_summa").value;
        const info = document.getElementById("x_info").value;

        if (!sum || !date || !type)
          return alert("Iltimos, barcha kataklarni to'ldiring!");

        const m = new Date(date).getMonth();
        let q = m <= 2 ? "q1" : m <= 5 ? "q2" : m <= 8 ? "q3" : "q4";

        db.ref(`asmo_fin/${activeDept}/${q}`)
          .push({
            date,
            type,
            sum: Number(sum),
            info: info || "-",
            ts: Date.now(),
          })
          .then(() => {
            document.getElementById("x_type").value = "";
            document.getElementById("x_summa").value = "";
            document.getElementById("x_info").value = "";
          })
          .catch((err) => alert("Bazaga yozishda xatolik: " + err.message));
      };

      function loadData() {
        ["q1", "q2", "q3", "q4"].forEach((qKey) => {
          db.ref(`asmo_fin/${activeDept}/${qKey}`).on("value", (snap) => {
            const list = document.getElementById(`list-${qKey}`);
            const total = document.getElementById(`total-${qKey}`);
            if (!list || !total) return;

            list.innerHTML = "";
            let qSum = 0;
            const val = snap.val();

            if (val) {
              Object.keys(val)
                .reverse()
                .forEach((id) => {
                  const item = val[id];
                  qSum += item.sum;
                  list.innerHTML += `
                  <tr class="${item.type.toLowerCase().includes("elektrod") ? "elektrod-active" : ""}">
                    <td><span class="badge bg-light text-dark p-2">${item.date}</span></td>
                    <td class="fw-bold text-dark">${item.type}</td>
                    <td class="text-secondary"><small>${item.info}</small></td>
                    <td class="fw-bold text-primary">${item.sum.toLocaleString()} so'm</td>
                    <td><button onclick="delItem('${qKey}','${id}')" class="btn btn-sm btn-outline-danger border-0 rounded-circle">ðŸ—‘</button></td>
                  </tr>`;
                });
            }
            total.innerText = qSum.toLocaleString() + " so'm";
          });
        });
      }

      window.delItem = function (q, id) {
        if (confirm("Ushbu ma'lumotni o'chirmoqchimisiz?"))
          db.ref(`asmo_fin/${activeDept}/${q}/${id}`).remove();
      };

      if (typeof db !== "undefined") loadData();
    </script>
  </body>
</html>
